// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RfidStatus {
  IN_STOCK
  SOLD
  LOST
  INACTIVE
}

enum ReceiptStatus {
  DRAFT
  PAID
  CANCELED
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ‘¤ NgÆ°á»i dÃ¹ng há»‡ thá»‘ng
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  role      String   @default("staff")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  receipts  Receipt[]
  poCreated PurchaseOrder[] @relation("PO_CreatedBy")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ­ NhÃ  cung cáº¥p
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model Supplier {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  

  purchaseOrders PurchaseOrder[]
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“¦ Sáº£n pháº©m trong kho
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model Product {
  id        Int      @id @default(autoincrement())
  sku       String   @unique                    // MÃ£ sáº£n pháº©m (dÃ¹ng Ä‘á»ƒ so sÃ¡nh khi nháº­p hÃ ng)
  name      String
  sellPrice Decimal  @db.Decimal(12, 2)         // GiÃ¡ bÃ¡n hiá»‡n hÃ nh
  stock     Int      @default(0)                // Sá»‘ lÆ°á»£ng tá»“n kho
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rfids        Rfid[]
  receiptItems ReceiptItem[]
  poItems      PurchaseOrderItem[]
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ§¾ ThÃ´ng tin Ä‘Æ¡n nháº­p hÃ ng
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model PurchaseOrder {
  id          Int      @id @default(autoincrement())
  supplierId  Int
  createdById Int
  status      String   @default("draft") // draft -> pending -> received
  totalCost   Decimal  @default(0) @db.Decimal(14, 2)
  note        String?
  createdAt   DateTime @default(now())
  

  supplier  Supplier @relation(fields: [supplierId], references: [id])
  createdBy User     @relation("PO_CreatedBy", fields: [createdById], references: [id])
  items     PurchaseOrderItem[]
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“¦ DÃ²ng sáº£n pháº©m trong Ä‘Æ¡n nháº­p
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model PurchaseOrderItem {
  id        Int      @id @default(autoincrement())
  poId      Int
  productId Int?                                       // CÃ³ thá»ƒ null (sáº£n pháº©m má»›i chÆ°a cÃ³ trong Product)
  name      String                                    // TÃªn hÃ ng nháº­p
  sku       String                                    // MÃ£ SKU hÃ ng nháº­p
  qty       Int                                       // Sá»‘ lÆ°á»£ng nháº­p
  unitCost  Decimal  @db.Decimal(12, 2)               // GiÃ¡ nháº­p / 1 sáº£n pháº©m
  sellPrice Decimal  @db.Decimal(12, 2)               // GiÃ¡ bÃ¡n Ä‘á» xuáº¥t
  lineTotal Decimal  @db.Decimal(14, 2)               // Tá»•ng giÃ¡ dÃ²ng = qty * unitCost
  updatedAt DateTime @updatedAt


  po      PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  product Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)

  rfids Rfid[] @relation("POItemRfids")

  @@index([poId])
  @@index([productId])
  @@index([sku])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ§¾ HoÃ¡ Ä‘Æ¡n bÃ¡n hÃ ng
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model Receipt {
  id         Int           @id @default(autoincrement())
  userId     Int
  totalQty   Int           @default(0)
  subtotal   Decimal       @default(0) @db.Decimal(12, 2)
  discount   Decimal       @default(0) @db.Decimal(12, 2)
  totalPrice Decimal       @default(0) @db.Decimal(12, 2)
  status     ReceiptStatus @default(DRAFT)
  createdAt  DateTime      @default(now())
  

  user  User          @relation(fields: [userId], references: [id])
  items ReceiptItem[]
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ§¾ DÃ²ng hÃ ng trong hoÃ¡ Ä‘Æ¡n bÃ¡n
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model ReceiptItem {
  id        Int      @id @default(autoincrement())
  receiptId Int
  productId Int
  qty       Int      @default(1)
  unitPrice Decimal  @db.Decimal(12, 2)
  lineTotal Decimal  @default(0) @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  

  receipt Receipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  rfids Rfid[] @relation("ReceiptItemRfids")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ”– ThÃ´ng tin tháº» RFID
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model Rfid {
  uid        String     @id
  productId  Int
  status     RfidStatus @default(IN_STOCK)
  lastSeenAt DateTime?

  receiptItemId Int?
  poItemId      Int?

  product     Product           @relation(fields: [productId], references: [id], onDelete: Restrict)
  receiptItem ReceiptItem?      @relation("ReceiptItemRfids", fields: [receiptItemId], references: [id], onDelete: SetNull)
  poItem      PurchaseOrderItem?@relation("POItemRfids", fields: [poItemId], references: [id], onDelete: SetNull)

  events RfidEvent[] @relation("RfidToEvents")

  @@index([productId])
  @@index([status])
  @@index([receiptItemId])
  @@index([poItemId])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ§­ Nháº­t kÃ½ sá»± kiá»‡n quÃ©t RFID
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model RfidEvent {
  id        Int      @id @default(autoincrement())
  rfidUid   String
  action    String
  timestamp DateTime @default(now())

  rfid Rfid @relation("RfidToEvents", fields: [rfidUid], references: [uid], onDelete: Cascade)

  @@index([rfidUid])
  @@index([action])
  @@index([timestamp])
}
